<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>マイクからのリアルタイム監視</title>
<link rel="manifest" href="manifest.json">

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        padding: 20px;
        text-align: center;
    }
    button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px;
    }
    #liveAudio {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #fff;
        overflow-wrap: break-word;
    }
</style>
</head>
<body>
<h1>マイクからのリアルタイム監視</h1>
<button id="startButton">音声を開始</button>
<button id="stopButton" disabled>音声を停止</button>
<div id="liveAudio"></div>

<script>
let audioContext;
let microphoneStream;
let scriptNode;
let audioBufferSourceNode;

async function startLiveAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const sourceNode = audioContext.createMediaStreamSource(microphoneStream);
        const destinationNode = audioContext.destination;

        scriptNode = audioContext.createScriptProcessor(4096, 1, 1);

        scriptNode.onaudioprocess = event => {
            const inputBuffer = event.inputBuffer;
            const inputData = inputBuffer.getChannelData(0);

            const outputBuffer = audioContext.createBuffer(1, inputBuffer.length, audioContext.sampleRate);
            const outputData = outputBuffer.getChannelData(0);
            outputData.set(inputData);

            if (audioBufferSourceNode) {
                audioBufferSourceNode.stop();
            }

            audioBufferSourceNode = audioContext.createBufferSource();
            audioBufferSourceNode.buffer = outputBuffer;
            audioBufferSourceNode.connect(destinationNode);
            audioBufferSourceNode.start();
        };

        sourceNode.connect(scriptNode);
        scriptNode.connect(destinationNode);

        document.getElementById('startButton').disabled = true;
        document.getElementById('stopButton').disabled = false;
    } catch (error) {
        console.error('録音の許可が得られませんでした: ', error);
    }
}

function stopLiveAudio() {
    document.getElementById('startButton').disabled = false;
    document.getElementById('stopButton').disabled = true;

    if (microphoneStream) {
        microphoneStream.getTracks().forEach(track => track.stop());
    }

    if (audioContext) {
        audioContext.close();
    }

    if (audioBufferSourceNode) {
        audioBufferSourceNode.stop();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('startButton').addEventListener('click', startLiveAudio);
    document.getElementById('stopButton').addEventListener('click', stopLiveAudio);

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            stopLiveAudio();
        }
    });
});

// ページを閉じた時に録音を停止する
window.addEventListener('beforeunload', stopLiveAudio);
</script>
</body>
</html>
